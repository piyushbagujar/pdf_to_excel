<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF to Excel Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .file-input-label {
            cursor: pointer;
            background-color: #2563eb;
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            transition-property: background-color;
            transition-duration: 300ms;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .file-input-label:hover {
            background-color: #1e40af;
        }
        .file-input-label.disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">

    <div id="app-container" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl text-center">
        <h1 class="text-3xl font-bold text-gray-800 mb-4">Batch PDF to Excel Converter</h1>
        <p class="text-gray-600 mb-6">Upload multiple electricity bill PDFs to extract and combine key company fields into a single Excel-friendly file.</p>
        <p id="user-id" class="text-xs text-gray-500 mb-4 break-words">User ID: Connecting to database...</p>
        <input type="file" id="pdf-upload" accept=".pdf" multiple class="hidden">
        <label for="pdf-upload" id="file-input-label" class="file-input-label disabled">
            Choose PDF Files
        </label>

        <div id="loading-spinner" class="mt-8 hidden flex items-center justify-center text-blue-600">
            <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span id="loading-message">Processing files...</span>
        </div>

        <div id="success-message" class="mt-8 hidden text-green-600 font-semibold">
            All files processed successfully!
        </div>

        <div id="extracted-data-container" class="mt-8 w-full hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Processed Bills</h2>
            <div id="processed-files-list" class="bg-gray-50 p-4 rounded-lg text-left overflow-x-auto mb-4">
                <!-- List of processed files from Firestore will be added here -->
            </div>
            <div class="mt-4 flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-4">
                <button id="download-btn" class="bg-purple-600 text-white font-semibold py-2 px-4 rounded-full hover:bg-purple-700 transition duration-300 shadow-md">
                    Download All as CSV
                </button>
            </div>
        </div>

        <div id="error-message" class="mt-8 text-red-600 font-semibold hidden"></div>

        <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
                <h3 id="modal-title" class="text-lg font-bold mb-4"></h3>
                <p id="modal-content" class="text-gray-700 mb-4"></p>
                <button onclick="closeModal()" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-full hover:bg-blue-700 transition duration-300">Close</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        setLogLevel('debug');
        
        // --- YOUR FIREBASE CONFIGURATION GOES HERE ---
        // Get this from your own Firebase project console.
        // NOTE: The error 'auth/configuration-not-found' means you need to enable the Anonymous sign-in method in your Firebase project.
        // Go to Authentication > Sign-in method > Anonymous and enable it.
        const firebaseConfig = {
            apiKey: "AIzaSyDpzAS8JURIpu5Ie8cbbxVkNu4sSpnLLE0",
            authDomain: "pdftoexcel-6a689.firebaseapp.com",
            projectId: "pdftoexcel-6a689",
            storageBucket: "pdftoexcel-6a689.firebasestorage.app",
            messagingSenderId: "47426392464",
            appId: "1:47426392464:web:e5a6f3d8cfc17b0a97e315",
            measurementId: "G-3Q38V589SY"
        };
        
        const API_KEY = "AIzaSyAOEXExC8EFv_UKhUkUMRj0DSkDfZA_Ywk";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let allExtractedData = [];
        const COLLECTION_PATH = `bills_data`; // Use a simple collection name for your own project

        document.getElementById('pdf-upload').addEventListener('change', handleFileSelect, false);
        document.getElementById('download-btn').addEventListener('click', downloadCSV, false);

        // --- Firebase Initialization and Authentication ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, (user) => {
                    console.log("Auth state changed. User:", user ? user.uid : 'null');
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id').textContent = `User ID: ${userId}`;
                        isAuthReady = true;
                        document.getElementById('file-input-label').classList.remove('disabled');
                        listenForBills();
                    } else {
                         // Sign in anonymously to get a user ID
                        signInAnonymously(auth);
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showError("Failed to initialize the database. Please check your Firebase config and security rules.");
            }
        }
        
        // Ensure initializeFirebase is called only once after the document is ready
        window.addEventListener('load', initializeFirebase);

        function listenForBills() {
            if (!db || !userId) {
                console.warn("Firestore or User ID not ready. Aborting listener setup.");
                return;
            }
            console.log(`Setting up Firestore listener for user: ${userId}`);
            const billsCollection = collection(db, `${COLLECTION_PATH}/${userId}/bills`);
            const q = query(billsCollection);

            onSnapshot(q, (querySnapshot) => {
                console.log("Received data from Firestore. Updating UI.");
                allExtractedData = [];
                const listContainer = document.getElementById('processed-files-list');
                listContainer.innerHTML = '';
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    data.id = doc.id;
                    allExtractedData.push(data);
                    showProcessedFile(data.FileName);
                });
                if (allExtractedData.length > 0) {
                    document.getElementById('extracted-data-container').classList.remove('hidden');
                }
            }, (error) => {
                console.error("Error listening to Firestore:", error);
                showError("Failed to load your processed bills. Please refresh the page.");
            });
        }
        
        function showLoading(message) {
            document.getElementById('loading-spinner').classList.remove('hidden');
            document.getElementById('loading-message').textContent = message;
            document.getElementById('error-message').classList.add('hidden');
            document.getElementById('success-message').classList.add('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-spinner').classList.add('hidden');
        }

        function showProcessedFile(fileName) {
            const listContainer = document.getElementById('processed-files-list');
            const fileElement = document.createElement('div');
            fileElement.className = "flex items-center justify-between py-2 border-b last:border-b-0";
            fileElement.innerHTML = `
                <span class="text-gray-800 font-medium">${fileName}</span>
                <span class="text-green-500">âœ“ Saved</span>
            `;
            listContainer.appendChild(fileElement);
        }

        function showError(message) {
            hideLoading();
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = `Error: ${message}`;
            errorElement.classList.remove('hidden');
        }

        function openModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').textContent = content;
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        function downloadCSV() {
            if (allExtractedData.length === 0) {
                openModal('Download Error', 'No data to download. Please upload and process PDF files first.');
                return;
            }

            // Get all unique keys from all documents to form the CSV header
            const allKeys = new Set();
            allExtractedData.forEach(item => {
                Object.keys(item).forEach(key => {
                    if (key !== 'id' && key !== 'FileName') {
                        allKeys.add(key);
                    }
                });
            });
            const sortedKeys = Array.from(allKeys).sort();

            // Create the header row: "Field Name", then one column for each file
            let header = ["Field Name"].concat(allExtractedData.map(data => data.FileName));
            let csvContent = header.map(h => `"${h.toString().replace(/"/g, '""')}"`).join(',') + '\n';
        
            // Create the data rows
            sortedKeys.forEach(fieldName => {
                let row = [`"${fieldName.toString().replace(/"/g, '""')}"`];
                allExtractedData.forEach(fileData => {
                    const value = fileData[fieldName] !== undefined ? fileData[fieldName] : 'N/A';
                    // Escape double quotes in the value
                    const escapedValue = String(value).replace(/"/g, '""');
                    row.push(`"${escapedValue}"`);
                });
                csvContent += row.join(',') + '\n';
            });
        
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'bills_data.csv';
            a.click();
            URL.revokeObjectURL(a.href);
        }

        async function handleFileSelect(event) {
            if (!isAuthReady) {
                showError("User not authenticated. Please wait a moment and try again.");
                return;
            }

            const files = Array.from(event.target.files);
            if (files.length === 0) return;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                try {
                    showLoading(`Processing file ${i + 1} of ${files.length}: ${file.name}`);
                    const base64Pdf = await fileToBase64(file);
                    const data = await processPdfWithGemini(base64Pdf);
                    if (data) {
                        data.FileName = file.name;
                        await addDoc(collection(db, `${COLLECTION_PATH}/${userId}/bills`), data);
                    }
                } catch (error) {
                    console.error("Failed to process file:", error);
                    showError(`Failed to process ${file.name}. Please try again.`);
                    return;
                }
            }

            hideLoading();
            document.getElementById('success-message').classList.remove('hidden');
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        async function processPdfWithGemini(base64Pdf) {
            const prompt = `
            You are a data extraction expert. Your task is to extract all key fields and their corresponding values from the provided electricity bill PDF. Identify fields that would be important for a company's financial and technical records.

            For each field, provide its exact name as the key and its corresponding value. If a field has sub-fields (like 'Energy Charges' having 'Units' and 'Rate'), represent them as nested key-value pairs.

            Format the output as a single JSON object. Do not include any other text or explanation. If a field is not found, use a value of 'N/A'.
            `;

            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        { inlineData: { mimeType: "application/pdf", data: base64Pdf } }
                    ]
                }]
            };

            const maxRetries = 3;
            let currentRetry = 0;
            const delay = (ms) => new Promise(res => setTimeout(res, ms));

            while (currentRetry < maxRetries) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429) {
                            const retryAfter = response.headers.get('Retry-After') || (1 << currentRetry);
                            await delay(retryAfter * 1000);
                            currentRetry++;
                            continue;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    let jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (jsonText && jsonText.startsWith('```json')) {
                        jsonText = jsonText.substring('```json'.length, jsonText.lastIndexOf('```')).trim();
                    }

                    if (jsonText) {
                        try {
                            const data = JSON.parse(jsonText);
                            const flattenedData = flattenObject(data);
                            return flattenedData;
                        } catch (e) {
                            console.error("Parsing error:", e);
                            return null;
                        }
                    } else {
                        return null;
                    }
                } catch (error) {
                    console.error('API call failed:', error);
                    currentRetry++;
                    if (currentRetry >= maxRetries) {
                        throw error;
                    }
                    await delay((1 << currentRetry) * 1000);
                }
            }
        }
        
        function flattenObject(obj, parentKey = '') {
            let flattened = {};
            for (let key in obj) {
                if (obj.hasOwnProperty(key)) {
                    const newKey = parentKey ? `${parentKey} - ${key}` : key;
                    if (typeof obj[key] === 'object' && obj[key] !== null) {
                        Object.assign(flattened, flattenObject(obj[key], newKey));
                    } else {
                        flattened[newKey] = obj[key];
                    }
                }
            }
            return flattened;
        }
    </script>
</body>
</html>
